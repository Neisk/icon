<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neisk å¤šçº§è§†é¢‘åº“</title>
<style>
:root{--bg:#0d0d0d;--card:#1a1a1a;--text:#f5f5f5;--muted:#999;--accent:#00b7ff;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
background:var(--bg);color:var(--text);padding:20px;text-align:center;}
h1{font-size:26px;color:var(--accent);margin-bottom:15px;}
input{width:90%;max-width:400px;padding:10px;border-radius:10px;border:none;background:#1f1f1f;color:var(--text);margin-bottom:25px;font-size:15px;}
ul{list-style:none;padding-left:0;margin:0;}
li{padding:6px 10px;border-radius:8px;margin:4px 0;cursor:pointer;background:#222;display:flex;align-items:center;}
li:hover{background:var(--accent);color:#000;}
.category{font-weight:600;}
.sublist{margin-left:20px;}
.gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:20px;max-width:1200px;margin:auto;}
.card{background:var(--card);border-radius:16px;overflow:hidden;transition:0.3s;cursor:pointer;}
.card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.3);}
.card img{width:100%;height:140px;object-fit:cover;background:#000;}
.info{padding:8px 10px;text-align:left;}
.title{font-size:14px;font-weight:600;}
.desc{font-size:12px;color:var(--muted);}
#pagination{margin-top:20px;}
#pagination button{margin:0 5px;padding:5px 12px;border:none;border-radius:8px;background:#222;color:var(--text);cursor:pointer;}
#pagination button:hover{background:var(--accent);color:#000;}
</style>
</head>
<body>
<h1>ğŸ¥ Neisk å¤šçº§è§†é¢‘åº“</h1>
<input type="text" id="search" placeholder="ğŸ” æœç´¢è§†é¢‘...">
<div id="library">æ­£åœ¨åŠ è½½è§†é¢‘åº“...</div>
<div class="gallery" id="gallery"></div>
<div id="pagination"></div>

<script>
const repo = "Neisk/icon"; // GitHub ä»“åº“
const folder = "mp4";
const library = document.getElementById("library");
const gallery = document.getElementById("gallery");
const searchInput = document.getElementById("search");
const paginationDiv = document.getElementById("pagination");
let videos = [];       // {category, name, folder}
let filteredVideos = [];
let currentPage = 1;
const pageSize = 12;

// åŠ è½½å¤šçº§åˆ†ç±»
async function loadLibrary(){
  try{
    const res = await fetch(`https://api.github.com/repos/${repo}/contents/${folder}`);
    const categories = (await res.json()).filter(f=>f.type==="dir");
    const ul = document.createElement("ul");
    categories.forEach(cat=>{
      const li = document.createElement("li");
      li.textContent = cat.name;
      li.className="category";
      li.onclick=()=>loadVideos(cat.name, li);
      ul.appendChild(li);
    });
    library.innerHTML="";
    library.appendChild(ul);
  }catch(e){
    library.innerHTML="<p style='color:#f55'>âŒ è§†é¢‘åº“åŠ è½½å¤±è´¥</p>";
  }
}

// åŠ è½½äºŒçº§ç›®å½•è§†é¢‘
async function loadVideos(categoryName, liElement){
  if(liElement.querySelector(".sublist")){
    liElement.querySelector(".sublist").remove();
    return;
  }
  const res = await fetch(`https://api.github.com/repos/${repo}/contents/${folder}/${categoryName}`);
  const data = await res.json();
  const videoDirs = data.filter(f=>f.type==="dir");
  const subUl = document.createElement("ul");
  subUl.className="sublist";
  videoDirs.forEach(v=>{
    const vLi = document.createElement("li");
    vLi.textContent = v.name;
    vLi.onclick=()=>loadGallery(categoryName, v.name);
    subUl.appendChild(vLi);
  });
  liElement.appendChild(subUl);
}

// åŠ è½½è§†é¢‘åº“åˆ° galleryï¼ˆè‡ªåŠ¨ç”Ÿæˆ CDN é“¾æ¥ï¼‰
async function loadGallery(categoryName, videoName){
  try{
    const res = await fetch(`https://api.github.com/repos/${repo}/contents/${folder}/${categoryName}/${videoName}`);
    const parts = (await res.json()).filter(f=>f.name.endsWith(".mp4")||f.name.endsWith(".mov"))
      .sort((a,b)=>a.name.localeCompare(b.name));
    if(parts.length===0) {gallery.innerHTML="<p>æš‚æ— è§†é¢‘</p>"; return;}
    const videoFolder = `${folder}/${categoryName}/${videoName}`;
    const videoObj = {category:categoryName, name:videoName, folder:videoFolder};
    videos = [videoObj]; // å½“å‰åªæ˜¾ç¤ºè¿™ä¸ªè§†é¢‘
    filteredVideos = videos;
    currentPage=1;
    renderGallery();
  }catch(e){gallery.innerHTML="<p style='color:#f55'>âŒ åŠ è½½å¤±è´¥</p>";}
}

// æ¸²æŸ“ gallery
function renderGallery(){
  gallery.innerHTML="";
  const start = (currentPage-1)*pageSize;
  const pageVideos = filteredVideos.slice(start,start+pageSize);
  pageVideos.forEach(v=>{
    const card = document.createElement("div");
    card.className="card";
    const img = document.createElement("img");
    img.src="https://via.placeholder.com/400x200?text=Loading...";
    const info = document.createElement("div");
    info.className="info";
    info.innerHTML=`<div class="title">${v.name}</div><div class="desc">${v.category}</div>`;
    card.appendChild(img);
    card.appendChild(info);
    gallery.appendChild(card);

    // å°é¢ç”Ÿæˆï¼ˆç¬¬ä¸€æ®µé¦–å¸§ï¼ŒCDN é“¾æ¥ï¼‰
    fetch(`https://api.github.com/repos/${repo}/contents/${v.folder}`)
      .then(res=>res.json())
      .then(parts=>{
        const mp4Part = parts.filter(f=>f.name.endsWith(".mp4")||f.name.endsWith(".mov"))
          .sort((a,b)=>a.name.localeCompare(b.name))[0];
        if(!mp4Part) return;
        const videoEl = document.createElement("video");
        videoEl.src = `https://cdn.jsdelivr.net/gh/${repo}@main/${v.folder}/${encodeURIComponent(mp4Part.name)}`;
        videoEl.crossOrigin="anonymous";
        videoEl.muted=true;
        videoEl.currentTime=0.1;
        videoEl.addEventListener("loadeddata",()=>{
          const canvas = document.createElement("canvas");
          canvas.width=videoEl.videoWidth;
          canvas.height=videoEl.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(videoEl,0,0,canvas.width,canvas.height);
          img.src=canvas.toDataURL("image/jpeg");
        });
      });

    card.onclick=()=>window.location.href=`player.html?folder=${v.folder}&title=${encodeURIComponent(v.name)}`;
  });
  renderPagination();
}

// æœç´¢
searchInput.addEventListener("input", ()=>{
  const key = searchInput.value.trim().toLowerCase();
  filteredVideos = videos.filter(v=>v.name.toLowerCase().includes(key));
  currentPage=1;
  renderGallery();
});

// åˆ†é¡µ
function renderPagination(){
  paginationDiv.innerHTML="";
  const totalPage = Math.ceil(filteredVideos.length/pageSize);
  if(totalPage<=1) return;
  if(currentPage>1){
    const prev=document.createElement("button");
    prev.textContent="ä¸Šä¸€é¡µ";
    prev.onclick=()=>{currentPage--; renderGallery();}
    paginationDiv.appendChild(prev);
  }
  if(currentPage<totalPage){
    const next=document.createElement("button");
    next.textContent="ä¸‹ä¸€é¡µ";
    next.onclick=()=>{currentPage++; renderGallery();}
    paginationDiv.appendChild(next);
  }
}

loadLibrary();
</script>
</body>
</html>
