<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>播放视频</title>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#0d0d0d;color:#f5f5f5;text-align:center;padding:20px;}
h1{color:#00b7ff;margin-bottom:10px;}
video{width:90%;max-width:800px;margin-bottom:10px;background:#000;}
#episodeList button{margin:3px;padding:5px 10px;border:none;border-radius:8px;background:#222;color:#fff;cursor:pointer;}
#episodeList button.active{background:#00b7ff;color:#000;}
#episodeList button:hover{background:#555;}
#loading{color:#00b7ff;margin:5px;}
a{color:#00b7ff;text-decoration:none;}
a:hover{text-decoration:underline;}
</style>
</head>
<body>
<h1 id="title"></h1>
<video id="player" controls autoplay playsinline preload="auto"></video>
<div id="loading">正在加载视频...</div>
<div id="episodeList"></div>
<a href="index.html">← 返回视频库</a>

<script>
const params = new URLSearchParams(location.search);
const folder = params.get("folder");
const title = params.get("title");
const player = document.getElementById("player");
const loading = document.getElementById("loading");
const episodeList = document.getElementById("episodeList");

if(!folder){
  document.body.innerHTML="<h1>⚠️ 视频地址错误</h1>";
}else{
  document.getElementById("title").innerText=decodeURIComponent(title);

  let episodes = [];
  let current = 0;

  fetch(`https://api.github.com/repos/Neisk/icon/contents/${folder}`)
    .then(res=>res.json())
    .then(data=>{
      episodes = data.filter(f=>f.name.endsWith(".mp4")||f.name.endsWith(".mov"))
        .sort((a,b)=>a.name.localeCompare(b.name))
        .map(f=>({
          name: f.name,
          url:`https://cdn.jsdelivr.net/gh/Neisk/icon@main/${folder}/${encodeURIComponent(f.name)}`
        }));
      if(episodes.length===0) throw "暂无视频";
      renderEpisodeList();
      playEpisode(0);
    }).catch(e=>loading.innerText="❌ 加载失败");

  function renderEpisodeList(){
    episodeList.innerHTML="";
    episodes.forEach((ep,i)=>{
      const btn = document.createElement("button");
      btn.textContent=ep.name;
      btn.onclick=()=>playEpisode(i);
      episodeList.appendChild(btn);
    });
  }

  function playEpisode(index){
    if(index<0 || index>=episodes.length) return;
    current=index;
    updateButtons();
    loading.style.display="block";
    player.src=episodes[index].url;
    player.play();
  }

  function updateButtons(){
    Array.from(episodeList.children).forEach((btn,i)=>{
      btn.classList.toggle("active",i===current);
    });
  }

  player.addEventListener("canplay",()=>{loading.style.display="none";});
  player.addEventListener("waiting",()=>{loading.style.display="block";});
  player.addEventListener("ended",()=>{
    if(current<episodes.length-1) playEpisode(current+1);
  });
}
</script>
</body>
</html>
